<!DOCTYPE html>
<html lang="es">
<head><meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><title>HexaTour — Detalle (Visitante)</title>
<style>:root{--bg:#fff;--text:#0a1219;--muted:#425466;--panel:#f8fafc;--border:#e2e8f0;--ring:#0d9488;--top-grad:rgba(56,189,248,.95);--bot-grad:rgba(34,197,94,.95)}*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;color:var(--text);background-image:linear-gradient(to bottom,var(--top-grad) 0%,rgba(255,255,255,0) 60%),linear-gradient(to top,var(--bot-grad) 0%,rgba(255,255,255,0) 60%);background-repeat:no-repeat,no-repeat;background-attachment:fixed,fixed;background-position:top left,bottom left;background-size:100% 45%,100% 45%}.wrap{max-width:480px;margin:0 auto;padding:16px}.top{display:flex;align-items:center;gap:10px}.back{border:none;border-radius:12px;padding:10px 12px;background:#374151;color:#fff;font-weight:800}h1{font-size:1.2rem;margin:0 0 0 6px}.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}.options{display:grid;grid-template-columns:1fr;gap:8px}.opt{background:var(--opt-bg,#0f172a);color:#fff;border:2px solid rgba(0,0,0,.06);border-radius:12px;padding:12px 10px;cursor:pointer;font-weight:800;box-shadow:0 4px 10px rgba(0,0,0,.08)}.opt.urg.carabineros{background:#166534;border:2px solid #000;color:#fff}.opt.urg.ambulancia{background:#fff;border:2px solid #dc2626;color:#111}.opt.urg.bomberos{background:#b91c1c;border:2px solid #f59e0b;color:#fff}.img{width:100%;height:auto;border-radius:12px;border:1px solid var(--border)}.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin-top:8px}.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}.btn{border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer;box-shadow:0 3px 0 rgba(0,0,0,.15)}.btn.route{background:#0ea5e9;color:#fff}.btn.download{background:#0284c7;color:#fff}.emg-msg{margin-top:10px;padding:10px 12px;border-radius:10px;border:2px solid #16a34a;background:#ecfdf5;color:#065f46;font-weight:800;text-align:center}</style></head>
<body><div class="wrap">
<div class="top"><button class="back" onclick="location.href='index.html'" type="button">← Volver</button><h1 id="title">Detalle</h1></div>
<section class="card"><div class="options" id="opts"></div><div class="emg-msg" hidden="" id="emgMsg">ALERTA ENVIADA!</div></section>
<section class="card" hidden="" id="detailCard">
<img alt="Lugar" class="img" decoding="async" id="detailImg" loading="lazy"/>
<div class="kv"><b>Descripción</b><span id="desc">—</span><b>Tiempo a pie</b><span id="tPie">—</span><b>Tiempo en vehículo</b><span id="tVeh">—</span><b>Apertura</b><span id="hOpen">—</span><b>Cierre</b><span id="hClose">—</span><b>Alertas</b><span id="alert">—</span></div>
<div class="row"><button class="btn route" id="routeBtn" type="button">Ruta</button><button class="btn download" hidden="" id="downloadBtn" type="button">Descargar</button></div>
<img alt="Ruta" class="img" decoding="async" id="routeImg" style="display:none;margin-top:8px"/></section>
</div>
<script>
// COMMON_START

// Punto de instalación de HexaTour para mensajes de urgencia.
// Ajustar este texto en el firmware/SPA según el lugar específico.
const HEXATOUR_PUNTO = 'PUNTO_HEXATOUR_AQUI';

function buildSmsBodyUrgencia(tipo){
  return [
    'ALERTA URGENCIA HEXATOUR',
    'Punto: ' + HEXATOUR_PUNTO,
    'Servicio requerido: ' + tipo,
    'Urgencia: [describa brevemente]',
    'Se necesita con urgencia: [indique lo que requiere]'
  ].join('\n');
}

function normalize(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ñ/g,'n');}
function catFolder(cat){
  switch(cat){
    case 'Restaurantes': return 'restaurantes';
    case 'Hospedajes': return 'hospedajes';
    case 'Plazas': return 'plazas';
    case 'Ríos': return 'rios';
    case 'Pisqueras': return 'pisqueras';
    case 'Campings': return 'campings';
    case 'Ferias Artesanales': return 'ferias';
    case 'Servicios': return 'servicios';
    case 'Universidad': return 'universidad';
    case 'Urgencia': return 'urgencias';
    default: return 'otros';
  }
}
function labelBase(cat){
  switch(cat){
    case 'Restaurantes': return 'Restaurante';
    case 'Hospedajes': return 'Hospedaje';
    case 'Plazas': return 'Plaza';
    case 'Ríos': return 'Río';
    case 'Pisqueras': return 'Pisquera';
    case 'Campings': return 'Camping';
    case 'Ferias Artesanales': return 'Feria';
    case 'Servicios': return 'Servicio';
    case 'Universidad': return 'Universidad';
    case 'Urgencia': return 'Urgencia';
    default: return 'Lugar';
  }
}
function slugify(s){ return normalize(s).replace(/[^a-z0-9]+/g,'').trim(); }

// COMMON_END
// LOAD_START

async function loadMeta(current, targets){
  const p = `${current.folder}/${current.slug}.txt`;
  const candidates = [`../datos/${p}`, `/datos/${p}`, `/www/datos/${p}`, `../../datos/${p}`, `datos/${p}`];
  let ok = null;
  for (const u of candidates){
    try{ const r = await fetch(u, {cache:'no-store'}); if(r.ok){ ok = await r.text(); break; } }catch(e){}
  }
  if(!ok){ targets.desc.textContent='Metadatos no encontrados.'; return; }
  const N = s=> (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ñ/g,'n').trim();
  const map = {};
  ok.split(/\r?\n+/).forEach(line=>{
    if(!line || line.trim().startsWith('#')) return;
    const m = line.match(/^\s*([^=]+?)\s*=\s*(.*?)\s*$/);
    if(m){ map[N(m[1])] = m[2]; }
  });
  if(map['descripcion']) targets.desc.textContent  = map['descripcion'];
  if(map['tpie'])        targets.tPie.textContent  = map['tpie'];
  if(map['tveh'])        targets.tVeh.textContent  = map['tveh'];
  if(map['apertura'])    targets.hOpen.textContent = map['apertura'];
  if(map['cierre'])      targets.hClose.textContent= map['cierre'];
  if(map['alertas'])     targets.alertEl.textContent = map['alertas'];
}

// LOAD_END
(function(){
  const $ = s=>document.querySelector(s);
  const url = new URL(location.href);
  const cat = url.searchParams.get('cat') || '';
  $('#title').textContent = cat || 'Selecciona una categoría';

  const opts = $('#opts'), detailCard = $('#detailCard'), img = $('#detailImg'), routeImg = $('#routeImg');
  const desc = $('#desc'), tPie = $('#tPie'), tVeh = $('#tVeh'), hOpen = $('#hOpen'), hClose = $('#hClose'), alertEl = $('#alert');
  const routeBtn = $('#routeBtn'), downloadBtn = $('#downloadBtn'), emgMsg = $('#emgMsg');
  let current = null;

  async function renderOpts(){
    opts.innerHTML = ''; emgMsg.hidden = true; emgMsg.textContent = 'ALERTA ENVIADA!';

    if (cat === 'Urgencia') {
      ['Carabineros','Ambulancia','Bomberos'].forEach(n=>{
        const b = document.createElement('button');
        b.className = 'opt urg ' + (n==='Carabineros'?'carabineros':n==='Ambulancia'?'ambulancia':'bomberos');
        b.type = 'button'; b.textContent = n;
        b.onclick = ()=> {
          if(confirm(`¿Está seguro de contactar a ${n} por SMS?`)){
            const phone = '+56935774427';
            const body = buildSmsBodyUrgencia(n);
            const smsUrl = `sms:${phone}?body=${encodeURIComponent(body)}`;
            try{
              emgMsg.hidden = false;
              emgMsg.textContent = 'Abriendo app de mensajes...';
            }catch(e){}
            location.href = smsUrl;
          }
        };
        opts.appendChild(b);
      });
      detailCard.hidden = true; return;
    }

    const base = labelBase(cat || 'Restaurantes');
    const folder = catFolder(cat || 'Restaurantes');
    const baseSlug = slugify(base);
    const col = {'Restaurantes':'#c2410c','Hospedajes':'#1d4ed8','Plazas':'#16a34a','Ríos':'#0d9488','Pisqueras':'#b45309','Campings':'#047857','Ferias Artesanales':'#7c3aed','Servicios':'#374151','Universidad':'#0284c7'}[cat] || '#0f172a';
    document.documentElement.style.setProperty('--opt-bg', col);

    let used = false;
    let nameMap = {};
    try{
      const rn = await fetch(`../datos/${folder}/nombres.txt`, {cache:'no-store'});
      if(rn.ok){
        const txt = await rn.text();
        txt.split(/\r?\n+/).forEach(line=>{
          const l = line.trim();
          if(!l || l.startsWith('#')) return;
          const parts = l.split('|');
          const id = (parts[0]||'').trim();
          const label = (parts[1]||'').trim();
          if(id && label){ nameMap[id] = label; }
        });
      }
    }catch(e){}
    try{
      const r = await fetch(`../datos/${folder}/_index.txt`, {cache:'no-store'});
      if(r.ok){
        const lines = (await r.text()).split(/\r?\n+/).map(s=>s.trim()).filter(s=>s && !s.startsWith('#'));
        if(lines.length){
          lines.forEach(slug=>{
            const suf = slug.startsWith(baseSlug) ? slug.slice(baseSlug.length) : slug;
            const fallbackName = `${base} ${suf.toUpperCase()}`;
            const displayName = nameMap[slug] || fallbackName;
            const btn = document.createElement('button');
            btn.className='opt';
            btn.type='button';
            btn.textContent=displayName;
            btn.onclick = ()=> selectPlace(slug, displayName);
            opts.appendChild(btn);
          });
          used = true;
        }
      }
    }catch(e){}

    if(!used){
      'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(suf=>{
        const name = `${base} ${suf}`;
        const slug = slugify(name);
        const testSrc = `../img/${folder}/${slug}.jpg`;
        const b = document.createElement('button');
        b.className='opt';
        b.type='button';
        b.textContent=name;
        b.style.display='none';
        b.onclick = ()=> selectPlace(slug, name);
        opts.appendChild(b);
        const probe = new Image();
        probe.onload = ()=>{ b.style.display=''; };
        probe.onerror = ()=>{ b.remove(); };
        probe.src = testSrc;
      });
    }

    detailCard.hidden = true;
  }

  function selectPlace(slug, name){
    const folder = catFolder(cat || 'Restaurantes');
    current = {cat, folder, name, slug};

    img.onerror = ()=>{ img.style.display='none'; };
    img.src = `../img/${folder}/${slug}.jpg`;
    img.alt = `Imagen de ${name}`;
    img.style.display = 'block';

    routeImg.style.display='none';
    routeImg.removeAttribute('src');
    downloadBtn.hidden = true;

    desc.textContent='—';
    tPie.textContent='—';
    tVeh.textContent='—';
    hOpen.textContent='—';
    hClose.textContent='—';
    alertEl.textContent='—';

    loadMeta(current, {desc, tPie, tVeh, hOpen, hClose, alertEl});

    detailCard.hidden = false;
  }

  routeBtn.addEventListener('click', ()=>{
    if(!current) return;
    routeImg.onload = ()=>{ routeImg.style.display='block'; downloadBtn.hidden = false; };
    routeImg.onerror = ()=>{ routeImg.style.display='none'; downloadBtn.hidden = true; alert('No se encontró la imagen de ruta.'); };
    routeImg.removeAttribute('loading'); routeImg.setAttribute('loading','eager'); routeImg.decoding = 'async';
    routeImg.src = `../img/${current.folder}/ruta${current.slug}.jpg`; routeImg.alt = `Ruta hacia ${current.name}`;
    routeImg.setAttribute('sizes', '(max-width: 768px) 90vw, 720px');
    routeImg.setAttribute('srcset', `../img/${current.folder}/ruta${current.slug}-640.jpg 640w, ../img/${current.folder}/ruta${current.slug}-1280.jpg 1280w`);
  });

  downloadBtn.addEventListener('click', ()=>{
    if(!current) return;
    const file = `${current.folder}/indicaciones${current.slug}ruta.txt`;
    const url = `../api/route-pdf?name=${encodeURIComponent(current.name)}&file=${encodeURIComponent(file)}&dl=0`;
    location.href = url;
  });

  renderOpts();
})();
</script>
</body></html>
